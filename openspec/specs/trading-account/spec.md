# trading-account Specification

## Purpose
提供模拟/交易账户的领域能力：账户生命周期、订单与成交状态机、持仓与资金流水账本，以及聚合统计与审计治理；所有读写通过持久化仓储与事务单元保证一致性。
## Requirements
### Requirement: 交易账户数据访问必须按用户隔离
交易账户、持仓、交易记录、资金流水相关接口 MUST 仅返回当前用户数据。

#### Scenario: 列表接口只返回当前用户账户
- **GIVEN** 系统中存在多个用户账户
- **WHEN** 当前用户调用账户列表接口
- **THEN** 返回结果仅包含 `userId == current_user.id` 的账户

### Requirement: 聚合统计必须基于用户权限范围
账户统计与分析 API MUST 只统计当前用户可访问的账户数据。

#### Scenario: 越权账户不参与统计
- **GIVEN** 请求参数包含他人账户 ID
- **WHEN** 调用统计接口
- **THEN** 返回 403 或忽略该账户并返回权限错误
- **AND** 不得混入他人数据

### Requirement: 交易写操作必须通过持久化仓储与事务单元执行
账户、持仓、成交、资金流水等写入 MUST 通过持久化仓储与 Unit of Work 执行，确保原子性与可恢复性。

#### Scenario: 交易写入在事务内保持一致
- **GIVEN** 用户发起一次交易写操作
- **WHEN** 系统执行账户与流水更新
- **THEN** 相关写入必须在同一事务边界内提交或回滚
- **AND** 服务重启后数据状态保持一致

### Requirement: 订单生命周期必须完整可追踪
交易账户 MUST 提供订单创建、撤销、成交与查询能力，并通过状态机约束状态迁移。

#### Scenario: 订单从 pending 迁移为 filled
- **GIVEN** 用户提交买入订单且订单处于 `pending`
- **WHEN** 订单被执行成交
- **THEN** 订单状态迁移为 `filled`
- **AND** 生成关联成交记录

#### Scenario: 非法状态迁移被拒绝
- **GIVEN** 订单已处于 `cancelled`
- **WHEN** 再次请求成交确认
- **THEN** 返回 409
- **AND** 不生成额外成交记录

### Requirement: 账本事件必须保证资金与记录一致
成交与资金流水 MUST 在事务内保持一致，任何失败都应回滚。

#### Scenario: 成交写入失败触发回滚
- **GIVEN** 订单成交流程进入资金与流水写入阶段
- **WHEN** 流水写入失败
- **THEN** 账户余额与订单状态回滚到变更前
- **AND** 返回可识别的事务失败错误码

### Requirement: 交易读模型必须提供统计与概览能力
交易账户 MUST 提供订单、成交、资金流水及账户概览统计查询接口。

#### Scenario: 用户查询账户概览
- **GIVEN** 用户账户已有成交与持仓数据
- **WHEN** 调用账户概览接口
- **THEN** 返回总资产、可用资金、浮动盈亏等指标
- **AND** 结果仅包含当前用户可访问账户

### Requirement: 交易分析视图必须覆盖风险与绩效维度
交易账户 MUST 提供风险指标、权益曲线、仓位分析等高级读模型，支持用户评估账户健康度与策略表现。

#### Scenario: 用户查询账户权益曲线
- **GIVEN** 账户存在历史成交与资金流水
- **WHEN** 调用权益曲线接口
- **THEN** 返回按时间排序的权益序列
- **AND** 数据仅包含当前用户可访问账户

### Requirement: 交易运维接口必须受治理与审计约束
待处理交易查询与批量价格刷新等高风险接口 MUST 仅允许授权角色访问，并记录审计日志。

#### Scenario: 普通用户调用价格刷新接口被拒绝
- **GIVEN** 普通用户已认证
- **WHEN** 调用价格刷新接口
- **THEN** 返回 403
- **AND** 不触发任何市场价格刷新副作用

### Requirement: 交易运维接口必须采用统一管理员判定策略
交易运维接口（待处理订单、价格刷新）MUST 使用统一管理员判定策略，不得直接依赖单一字段。

#### Scenario: 角色为 admin 的用户可执行价格刷新
- **GIVEN** 当前用户 `role=admin`
- **WHEN** 调用价格刷新接口
- **THEN** 请求通过并执行刷新逻辑
- **AND** 审计记录包含判权来源

### Requirement: 交易账户必须具备完整生命周期管理能力
交易账户系统 MUST 提供账户创建、详情、更新与筛选配置读取能力。

#### Scenario: 用户创建并更新账户
- **GIVEN** 用户具备有效认证身份
- **WHEN** 调用账户创建与更新接口
- **THEN** 返回与当前用户绑定的账户信息
- **AND** 越权账户更新请求返回 403

### Requirement: 交易账户读模型必须提供账户与资金摘要
交易账户 MUST 提供账户摘要与资金流水摘要接口，用于前端首屏与运营视图。

#### Scenario: 查询账户资金流水摘要
- **GIVEN** 账户存在资金流水记录
- **WHEN** 调用资金流水摘要接口
- **THEN** 返回总流入/总流出/净额等聚合指标
- **AND** 指标仅基于当前用户可访问数据

### Requirement: 交易运维批处理必须支持任务化编排
交易运维批处理 MUST 覆盖待处理交易处理、日统计、风险巡检、批量交易执行与账户清理任务，并支持统一状态追踪。

#### Scenario: 提交待处理交易处理任务
- **GIVEN** 系统存在待处理交易
- **WHEN** 管理员提交处理任务
- **THEN** 返回可轮询 `taskId`
- **AND** 任务结果包含处理成功/失败数量

#### Scenario: 提交账户清理任务
- **GIVEN** 系统存在满足清理条件的账户历史数据
- **WHEN** 管理员提交账户清理任务
- **THEN** 返回任务状态句柄
- **AND** 清理范围遵循保留策略与审计规则

### Requirement: 交易日统计必须支持任务化生成与读取
交易系统 MUST 支持按日生成统计快照，并允许按账户或用户范围读取。

#### Scenario: 生成并读取指定交易日统计
- **GIVEN** 账户在目标交易日存在订单与成交数据
- **WHEN** 提交日统计任务并查询结果
- **THEN** 返回结构化统计指标
- **AND** 仅包含当前用户可访问账户数据

### Requirement: 交易系统必须支持可控的订单更新与删除
交易系统 MUST 支持对可编辑状态订单执行更新与删除（撤销）操作，并保持状态机约束。

#### Scenario: 更新 pending 订单成功
- **GIVEN** 用户拥有一个 `pending/open` 订单
- **WHEN** 调用订单更新接口修改可编辑字段
- **THEN** 返回更新后的订单
- **AND** 订单状态仍满足状态机约束

#### Scenario: 删除订单等价于受控撤销
- **GIVEN** 用户拥有一个可撤销订单
- **WHEN** 调用订单删除接口
- **THEN** 订单状态迁移为 `cancelled`
- **AND** 返回可追踪的撤销结果

### Requirement: 交易系统必须提供仓位与待处理交易快捷查询
交易系统 MUST 提供按标的单仓位查询与账户待处理交易查询能力，支撑交易运营与排障。

#### Scenario: 按标的查询单仓位
- **GIVEN** 账户持有某个标的仓位
- **WHEN** 调用单仓位查询接口
- **THEN** 返回该标的仓位详情

#### Scenario: 查询账户待处理交易
- **GIVEN** 账户存在 `pending/open` 交易
- **WHEN** 调用待处理交易查询接口
- **THEN** 返回仅包含待处理状态的交易记录

### Requirement: 交易系统必须提供业务级买卖指令入口
交易系统 MUST 提供 buy/sell 业务指令入口，以支持“下单即表达交易意图”的产品流程；内部实现 MAY 复用订单聚合与状态机。

#### Scenario: buy 指令成功生成交易结果
- **GIVEN** 用户账户资金充足且风控允许
- **WHEN** 用户提交 buy 指令
- **THEN** 系统生成可追踪订单与成交结果
- **AND** 账户资金与持仓按事务一致性更新

#### Scenario: buy 指令资金不足被拒绝
- **GIVEN** 用户账户可用资金不足
- **WHEN** 用户提交 buy 指令
- **THEN** 返回可识别错误码（如资金不足）
- **AND** 不得写入部分成交或异常流水

### Requirement: 交易运维接口不得接受 legacy is_admin
交易运维接口 MUST 不再接受 `is_admin` 字段作为管理员权限来源。

#### Scenario: legacy is_admin 访问运维接口被拒绝
- **GIVEN** 当前用户仅包含 `is_admin=true` 且无 `role=admin`
- **WHEN** 调用 trading ops 接口（如刷新价格/待处理订单）
- **THEN** 返回 403
- **AND** 错误码为 `ADMIN_REQUIRED`

### Requirement: 交易账户库不得再暴露 sqlite 持久化适配器
交易账户 capability MUST 不再把 sqlite 仓储作为受支持公开能力。

#### Scenario: 交易账户公开契约不包含 sqlite
- **GIVEN** 业务方通过交易账户库集成账户能力
- **WHEN** 检查公开导出与能力文档
- **THEN** 仅允许 `Postgres` 与 `InMemory` 作为可用仓储路径
- **AND** sqlite 路径不再受支持

