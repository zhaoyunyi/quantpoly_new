# trading-account Specification

## Purpose
TBD - created by archiving change add-trading-account-context-migration. Update Purpose after archive.
## Requirements
### Requirement: 交易账户数据访问必须按用户隔离
交易账户、持仓、交易记录、资金流水相关接口 MUST 仅返回当前用户数据。

#### Scenario: 列表接口只返回当前用户账户
- **GIVEN** 系统中存在多个用户账户
- **WHEN** 当前用户调用账户列表接口
- **THEN** 返回结果仅包含 `userId == current_user.id` 的账户

### Requirement: 聚合统计必须基于用户权限范围
账户统计与分析 API MUST 只统计当前用户可访问的账户数据。

#### Scenario: 越权账户不参与统计
- **GIVEN** 请求参数包含他人账户 ID
- **WHEN** 调用统计接口
- **THEN** 返回 403 或忽略该账户并返回权限错误
- **AND** 不得混入他人数据

### Requirement: 交易写操作必须通过持久化仓储与事务单元执行
账户、持仓、成交、资金流水等写入 MUST 通过持久化仓储与 Unit of Work 执行，确保原子性与可恢复性。

#### Scenario: 交易写入在事务内保持一致
- **GIVEN** 用户发起一次交易写操作
- **WHEN** 系统执行账户与流水更新
- **THEN** 相关写入必须在同一事务边界内提交或回滚
- **AND** 服务重启后数据状态保持一致

### Requirement: 订单生命周期必须完整可追踪
交易账户 MUST 提供订单创建、撤销、成交与查询能力，并通过状态机约束状态迁移。

#### Scenario: 订单从 pending 迁移为 filled
- **GIVEN** 用户提交买入订单且订单处于 `pending`
- **WHEN** 订单被执行成交
- **THEN** 订单状态迁移为 `filled`
- **AND** 生成关联成交记录

#### Scenario: 非法状态迁移被拒绝
- **GIVEN** 订单已处于 `cancelled`
- **WHEN** 再次请求成交确认
- **THEN** 返回 409
- **AND** 不生成额外成交记录

### Requirement: 账本事件必须保证资金与记录一致
成交与资金流水 MUST 在事务内保持一致，任何失败都应回滚。

#### Scenario: 成交写入失败触发回滚
- **GIVEN** 订单成交流程进入资金与流水写入阶段
- **WHEN** 流水写入失败
- **THEN** 账户余额与订单状态回滚到变更前
- **AND** 返回可识别的事务失败错误码

### Requirement: 交易读模型必须提供统计与概览能力
交易账户 MUST 提供订单、成交、资金流水及账户概览统计查询接口。

#### Scenario: 用户查询账户概览
- **GIVEN** 用户账户已有成交与持仓数据
- **WHEN** 调用账户概览接口
- **THEN** 返回总资产、可用资金、浮动盈亏等指标
- **AND** 结果仅包含当前用户可访问账户

### Requirement: 交易分析视图必须覆盖风险与绩效维度
交易账户 MUST 提供风险指标、权益曲线、仓位分析等高级读模型，支持用户评估账户健康度与策略表现。

#### Scenario: 用户查询账户权益曲线
- **GIVEN** 账户存在历史成交与资金流水
- **WHEN** 调用权益曲线接口
- **THEN** 返回按时间排序的权益序列
- **AND** 数据仅包含当前用户可访问账户

### Requirement: 交易运维接口必须受治理与审计约束
待处理交易查询与批量价格刷新等高风险接口 MUST 仅允许授权角色访问，并记录审计日志。

#### Scenario: 普通用户调用价格刷新接口被拒绝
- **GIVEN** 普通用户已认证
- **WHEN** 调用价格刷新接口
- **THEN** 返回 403
- **AND** 不触发任何市场价格刷新副作用

### Requirement: 交易运维接口必须采用统一管理员判定策略
交易运维接口（待处理订单、价格刷新）MUST 使用统一管理员判定策略，不得直接依赖单一字段。

#### Scenario: 角色为 admin 的用户可执行价格刷新
- **GIVEN** 当前用户 `role=admin`
- **WHEN** 调用价格刷新接口
- **THEN** 请求通过并执行刷新逻辑
- **AND** 审计记录包含判权来源

### Requirement: 交易账户必须具备完整生命周期管理能力
交易账户系统 MUST 提供账户创建、详情、更新与筛选配置读取能力。

#### Scenario: 用户创建并更新账户
- **GIVEN** 用户具备有效认证身份
- **WHEN** 调用账户创建与更新接口
- **THEN** 返回与当前用户绑定的账户信息
- **AND** 越权账户更新请求返回 403

### Requirement: 交易账户读模型必须提供账户与资金摘要
交易账户 MUST 提供账户摘要与资金流水摘要接口，用于前端首屏与运营视图。

#### Scenario: 查询账户资金流水摘要
- **GIVEN** 账户存在资金流水记录
- **WHEN** 调用资金流水摘要接口
- **THEN** 返回总流入/总流出/净额等聚合指标
- **AND** 指标仅基于当前用户可访问数据

### Requirement: 交易运维批处理必须支持任务化编排
交易价格刷新与批处理运维动作 MUST 支持任务化执行与结果追踪。

#### Scenario: 批量价格刷新返回任务状态
- **GIVEN** 管理员提交批量价格刷新请求
- **WHEN** 系统采用任务编排执行
- **THEN** 返回任务状态句柄
- **AND** 后续可查询执行结果与失败明细

