# signal-execution Specification

## Purpose
承载策略信号的生成、筛选查询、批量执行与执行历史治理能力：确保信号/执行记录按用户隔离，并提供留存、清理与审计等治理接口，作为交易执行链路的信号入口。
## Requirements
### Requirement: 信号与执行记录接口必须强制用户范围
信号查询、批处理、执行记录查询与取消 MUST 在服务端强制按当前用户过滤。

#### Scenario: 越权 signal_id 执行被拒绝
- **GIVEN** 信号不属于当前用户
- **WHEN** 调用执行或取消接口
- **THEN** 返回 403
- **AND** 信号状态不得发生变更

### Requirement: 维护类接口不得进行全局删除/更新
清理过期信号、清理旧执行记录等维护接口 MUST 限定用户作用域或仅限管理员角色。

#### Scenario: 普通用户调用全局清理接口
- **GIVEN** 普通用户已认证
- **WHEN** 调用清理接口
- **THEN** 返回 403
- **AND** 不应删除其他用户数据

### Requirement: 信号必须支持筛选搜索与批处理执行
信号执行系统 MUST 提供筛选、搜索、批量执行、批量取消能力，并保持用户隔离。

#### Scenario: 用户批量执行信号
- **GIVEN** 用户提交一组属于自己的待执行信号 ID
- **WHEN** 调用批量执行接口
- **THEN** 返回每个信号的执行结果
- **AND** 他人信号不得被执行

### Requirement: 维护类接口必须受治理约束
清理过期信号与全局维护接口 MUST 受管理员权限与审计约束。

#### Scenario: 普通用户调用全局维护接口
- **GIVEN** 普通用户已认证
- **WHEN** 调用全局清理接口
- **THEN** 返回 403
- **AND** 不执行任何删除或更新副作用

### Requirement: 策略执行控制面必须覆盖生成到处理闭环
信号执行系统 MUST 提供策略驱动信号生成、单信号处理（含风控前置）与执行详情查询能力。

#### Scenario: 策略触发信号生成并进入可处理状态
- **GIVEN** 用户提交有效策略与账户参数
- **WHEN** 调用策略驱动信号生成接口
- **THEN** 系统生成属于当前用户的待处理信号
- **AND** 信号后续可被单条处理接口消费

#### Scenario: 信号处理前风控失败则阻断执行
- **GIVEN** 待处理信号触发风控拒绝条件
- **WHEN** 调用单信号处理接口
- **THEN** 信号状态迁移为取消或拒绝
- **AND** 返回可识别风控错误语义

### Requirement: 执行读模型必须支持运行中与趋势分析
执行系统 MUST 提供运行中执行列表、策略维度统计与趋势视图。

#### Scenario: 查询运行中执行列表
- **GIVEN** 用户存在 `pending/running` 执行记录
- **WHEN** 调用运行中执行查询接口
- **THEN** 返回仅属于当前用户的执行记录
- **AND** 每条记录包含状态与最近更新时间

### Requirement: 信号全局维护接口必须采用统一管理员判定策略
信号系统的全局清理/维护接口 MUST 使用统一管理员判定策略，避免角色语义漂移。

#### Scenario: 管理员执行全局清理
- **GIVEN** 当前用户具备管理员权限
- **WHEN** 调用全局清理接口
- **THEN** 请求通过并返回清理结果
- **AND** 审计日志记录动作与判权依据

### Requirement: 信号生命周期必须支持详情与过期状态迁移
信号系统 MUST 提供信号详情读取与过期状态迁移能力。

#### Scenario: 信号过期迁移后不可执行
- **GIVEN** 信号已超过过期时间
- **WHEN** 系统执行过期迁移
- **THEN** 信号状态变为 `expired`
- **AND** 后续执行请求被拒绝

### Requirement: 信号中心必须提供筛选搜索与账户仪表板
信号系统 MUST 提供 pending/expired 筛选、搜索与账户维度统计仪表板。

#### Scenario: 查询账户信号仪表板
- **GIVEN** 账户存在多个状态的信号
- **WHEN** 调用仪表板接口
- **THEN** 返回按状态聚合的信号统计
- **AND** 不包含其他用户账户数据

### Requirement: 信号批处理必须支持任务化执行
信号批量执行与批量取消 MUST 支持任务化提交与状态查询。

#### Scenario: 批量执行返回任务句柄
- **GIVEN** 用户提交大批量信号执行请求
- **WHEN** 系统进入异步编排模式
- **THEN** 返回任务句柄（taskId）
- **AND** 用户可查询批处理进度与结果

### Requirement: 执行历史必须支持保留策略与清理治理
执行历史 MUST 支持按保留策略进行清理，并记录清理行为审计信息。

#### Scenario: 清理超期执行记录
- **GIVEN** 系统存在超过保留期限的执行记录
- **WHEN** 管理员触发清理任务
- **THEN** 仅清理超期记录
- **AND** 返回清理数量与审计标识

### Requirement: 信号分析必须支持日趋势与单信号绩效
信号系统 MUST 提供按天趋势视图与单信号绩效分析能力。

#### Scenario: 查询最近 N 天信号趋势
- **GIVEN** 用户存在跨多日信号执行数据
- **WHEN** 查询日趋势接口
- **THEN** 返回按日期聚合的趋势序列
- **AND** 仅包含当前用户数据

### Requirement: 信号生成必须支持策略驱动的市场数据评估
信号系统 MUST 支持“策略驱动信号生成”：根据 `strategyId` 的模板与参数，对指定账户与标的进行市场数据评估后生成 `BUY/SELL` 信号。

该能力 MUST 满足：

- 保持用户隔离：仅能生成当前用户可访问策略与账户的信号。
- 数据不足时可解释：当历史数据不足以计算指标时，系统 MUST 返回可识别的跳过原因。
- 跨上下文依赖必须通过 ACL/OHS：禁止直接引用策略域/行情域的仓储或内部模型。

#### Scenario: 策略处于 inactive 时不生成信号
- **GIVEN** 策略不处于可执行状态（如 `draft/archived`）
- **WHEN** 用户请求策略驱动生成
- **THEN** 返回空信号集合
- **AND** 返回可识别原因（如 `strategy_inactive`）

#### Scenario: 历史数据不足时返回跳过原因
- **GIVEN** 标的历史数据不足以计算指标
- **WHEN** 用户请求策略驱动生成
- **THEN** 系统不生成该标的信号
- **AND** 在响应中返回 `insufficient_data` 跳过原因

#### Scenario: 策略触发条件满足时生成 BUY/SELL 信号
- **GIVEN** 标的历史数据满足指标计算窗口
- **AND** 策略触发条件满足（如均线金叉/RSI 超卖）
- **WHEN** 用户请求策略驱动生成
- **THEN** 系统生成对应 `BUY/SELL` 信号
- **AND** 信号后续可被处理与执行接口消费

### Requirement: 信号系统必须支持手动过期与账户维度统计
信号系统 MUST 支持对单个信号执行手动过期，并提供账户维度统计视图。

#### Scenario: 用户手动过期自己的信号
- **GIVEN** 用户拥有一个未过期信号
- **WHEN** 调用手动过期接口
- **THEN** 信号状态变为 `expired`
- **AND** 返回更新后的信号详情

#### Scenario: 查询账户维度信号统计
- **GIVEN** 用户账户下存在多个信号
- **WHEN** 调用账户统计接口
- **THEN** 返回按状态聚合统计
- **AND** 不包含其他用户账户数据

### Requirement: 信号与执行记录必须支持可持久化存储装配
信号执行上下文 MUST 支持在 postgres 模式下持久化信号与执行记录，避免重启后状态丢失。

#### Scenario: 重启后执行记录可追踪
- **GIVEN** 用户已生成并处理多个信号
- **WHEN** 服务重启并查询执行记录
- **THEN** 仍可查询到重启前执行记录
- **AND** 仅返回当前用户数据

### Requirement: 策略执行查询必须提供模板按类型与策略维度统计读模型
信号执行系统 MUST 提供策略执行模板按类型查询，以及按策略维度的统计与趋势查询，避免前端跨上下文拼装。

#### Scenario: 按策略类型读取执行模板
- **GIVEN** 系统存在多种策略执行模板
- **WHEN** 用户按 `strategyType` 查询模板
- **THEN** 返回对应模板与参数定义
- **AND** 字段结构稳定且可用于参数校验

#### Scenario: 查询策略维度执行统计与趋势
- **GIVEN** 用户策略存在历史信号执行记录
- **WHEN** 用户按策略查询统计与趋势
- **THEN** 返回按策略聚合的统计结果与时间趋势序列
- **AND** 数据仅包含当前用户可访问策略

### Requirement: 信号执行仓储必须提供 sqlite 持久化适配器
信号执行上下文 MUST 提供 postgres 持久化仓储实现，并在 postgres 运行模式下持久化信号与执行记录。

#### Scenario: 信号与执行记录在重启后可追踪
- **GIVEN** 用户已生成并执行信号
- **WHEN** 服务重启后查询信号与执行记录
- **THEN** 返回重启前已提交数据
- **AND** 仅返回当前用户可访问数据

### Requirement: 信号全局维护接口不得接受 legacy is_admin
信号系统全局维护接口 MUST 不再接受 `is_admin` 字段作为管理员权限来源。

#### Scenario: legacy is_admin 调用全局维护被拒绝
- **GIVEN** 当前用户仅包含 `is_admin=true` 且无 `role=admin`
- **WHEN** 调用全局维护/清理接口
- **THEN** 返回 403
- **AND** 错误码为 `ADMIN_REQUIRED`

### Requirement: 信号库不得再暴露 sqlite 持久化适配器
信号执行 capability MUST 不再把 sqlite 仓储作为受支持公开能力。

#### Scenario: 信号公开契约不包含 sqlite
- **GIVEN** 业务方通过信号库集成信号与执行能力
- **WHEN** 检查公开导出与能力文档
- **THEN** 仅允许 `Postgres` 与 `InMemory` 作为可用仓储路径
- **AND** sqlite 路径不再受支持

