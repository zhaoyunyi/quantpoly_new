# add-capability-baseline-gates 设计说明

## 1. 设计目标

在“允许 breaking change，但功能不能缺失”的迁移策略下，建立统一、可执行、可阻断的能力门禁系统，确保每个 Wave 的切换依据是**能力等价**而不是接口兼容。

本设计解决三个核心问题：

1. 如何定义“功能不缺失”；
2. 如何在切换前做可重复验证；
3. 如何在切换后出现退化时快速回滚。

## 2. 范围与边界

### 2.1 纳入范围

- 迁移能力矩阵（用户旅程 × 限界上下文）
- BDD 场景验收（Given/When/Then）
- Wave 切换门禁与放行规则
- 失败回滚触发条件与回滚流程

### 2.2 不纳入范围

- 具体业务实现细节（由各业务 change 负责）
- 前端页面视觉与交互规范
- 旧接口兼容适配（本路线允许 break）

## 3. 能力门禁模型

## 3.1 双维度能力矩阵

- 维度 A（用户旅程）
  - 认证登录
  - 策略管理
  - 回测执行与结果
  - 交易账户与下单
  - 风控告警与处置
  - 实时监控
  - 偏好设置

- 维度 B（限界上下文）
  - `user-auth`
  - `user-preferences`
  - `strategy-management`
  - `backtest-runner`
  - `trading-account`
  - `market-data`
  - `risk-control`
  - `signal-execution`
  - `job-orchestration`
  - `monitoring-realtime`

每个格子必须映射到至少一个可执行场景。

## 3.2 门禁判定规则

- 任一关键能力场景失败 -> 阻断切换；
- 任一越权/数据泄露场景失败 -> 立即阻断并标记高风险；
- 切换后观察期内出现关键退化 -> 触发回滚。

## 4. Wave 切换流程

1. 切换前：执行能力矩阵检查与冒烟检查；
2. 切换中：仅允许单一组合入口切换开关；
3. 切换后：进入观察窗口，监控错误率、延迟、越权告警、任务积压；
4. 失败：按预定义回滚步骤恢复上一个稳定能力集。

## 5. 与现有规范对齐

- 对齐 `spec/ProgramSpec.md`：门禁校验必须可自动化、可 CLI 调用、可文本输出；
- 对齐 `spec/BDD_TestSpec.md`：验收场景统一 Given/When/Then；
- 对齐 `spec/DDDSpec.md`：能力矩阵按 bounded context 划分，避免跨界混杂。

## 6. 风险与缓解

- 风险：门禁定义过宽，导致“看似通过，实际不可用”。
  - 缓解：将“关键用户旅程”设为阻断级场景，默认严格。
- 风险：观察窗口指标定义不一致。
  - 缓解：固定指标与阈值模板，所有 Wave 使用同一口径。
- 风险：回滚条件模糊导致迟疑。
  - 缓解：显式化触发条件（如越权、核心写路径失败、错误率超阈）。

## 7. 交付物

- 能力等价矩阵文档（可版本化）
- 波次门禁清单
- 回滚 Runbook
- 对应 OpenSpec Requirement/Scenario
