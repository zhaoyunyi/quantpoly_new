# update-backend-composition-root 设计说明

## 1. 设计目标

建立单一后端组合入口（composition root），作为所有 REST/WS 能力的统一装配点、发布点和回滚点，服务于分波次硬切换。

目标是“统一治理而不破坏 bounded context”：

- 上下文内部仍保持独立；
- 对外入口统一；
- 横切能力统一（鉴权、错误、日志脱敏、观测）。

## 2. 架构方案

## 2.1 逻辑分层

1. **组合层（Composition Root）**
   - 负责初始化配置、依赖容器、router 注册、生命周期管理。
2. **上下文层（Bounded Context Libraries）**
   - 负责领域行为与上下文 API；不得感知其他上下文内部实现。
3. **横切层（Cross-Cutting）**
   - 统一鉴权依赖、统一错误信封、统一日志脱敏、统一指标埋点。

## 2.2 装配职责

- 统一挂载：`user-auth`、`strategy-management`、`backtest-runner`、`trading-account`、`market-data`、`risk-control`、`signal-execution`、`monitoring-realtime`；
- 统一注入 `get_current_user`；
- 统一输出 `success/error/paged` 响应信封；
- 统一 WS 鉴权与脱敏策略。

## 2.3 波次开关

组合入口提供模块级启停开关，用于 Wave 切换：

- 启用新上下文路由；
- 下线旧实现写路径；
- 必要时一键回滚到上一个稳定装配集。

## 3. 关键设计约束

- 不允许调用方绕过组合入口直接访问独立上下文入口；
- 不允许不同上下文返回不一致的权限错误结构；
- WS `/ws/monitor` 必须纳入统一入口治理。

## 4. 观测与安全

- 鉴权失败日志必须脱敏（token/cookie/header/body）；
- 统一记录请求 ID、用户 ID、上下文名称；
- 统一输出关键指标（错误率、延迟、WS 断连率）。

## 5. 渐进落地顺序

1. 先搭建组合入口骨架与路由注册；
2. 再迁入鉴权/错误/日志横切能力；
3. 最后接入波次开关与切换脚本。

## 6. 风险与缓解

- 风险：组合入口成为“上帝模块”。
  - 缓解：组合层只做装配，不承载领域逻辑。
- 风险：切换期间行为漂移。
  - 缓解：切换前后执行同一套能力门禁与冒烟场景。

## 7. 交付物

- 统一组合入口设计与模块装配清单
- 横切策略一致性清单
- Wave 切换与回滚开关设计
