# Wave 门禁规则、观察阈值与回滚策略

## 1. 功能缺失判定（阻断切换）

满足任一条件即判定“功能缺失”：

- 任一 `critical=true` 能力 `passed=false`
- 任一越权/跨用户数据泄露场景失败
- 核心写路径（下单/成交/状态迁移）失败

## 2. 切换前检查清单（Wave Gate Checklist）

- 鉴权路径：登录、会话校验、权限拒绝
- 核心写路径：策略变更、回测创建、交易写入
- 核心读路径：策略列表、回测列表、监控摘要
- 权限拒绝路径：跨用户资源访问应返回统一错误信封
- 异常路径：上游超时/限流错误码可识别且可重试语义正确

## 3. 切换后观察指标与阈值

- `errorRate <= 0.05`
- `p95LatencyMs <= 800`
- `queueBacklog <= 200`
- `dataLeakage = false`

## 4. 失败回滚触发规则

满足任一条件触发回滚：

- 关键能力失败（critical capability missing）
- `dataLeakage = true`
- `errorRate` 持续超过阈值

## 5. 回滚执行规则

1. 立刻冻结新流量切换动作
2. 切换模块开关到上一个稳定 capability 集合
3. 复跑冒烟脚本与能力门禁 CLI
4. 记录回滚审计（触发条件、时间、影响范围、恢复结果）
